# File Connector Example

File Connector can be used to perform operations in the local file system as well as in a remote server such as FTP and SFTP. 

## What you'll build

This example describes how to use the File Connector to write messages to local files and then read the files. Similarly, the same example can be configured to communicate with a remote file system (i.e FTP server) easily. The example also uses some other mediators coming with WSO2 EI to manipulate messages. 

<!--
Following diagram shows the overall solution.

<img src="{{base_path}}/assets/img/integrate/connectors/fileconnector-01.png" title="Adding a Rest API" width="800" alt="Adding a Rest API"/>
-->

An API is exposed to accept XML messages (employee information).
When a message is received, it is converted to a CSV message and then stored to a property. 
A check is done to see if the CSV file (with the same information) exists in the file system. If it does not exist, the connector creates a CSV file with CSV headers included. Then, the connector appends the new CSV entries in the current message to the CSV file. 
The connector then reads the same CSV file and converts the information back to XML and responds to the client.

<!--
If you do not want to configure this yourself, you can simply [get the project](#get-the-project) and run it.
-->

## Setting up the environment

Create a folder in your local file system with read and write access. This will be your working directory. In this example, it is `/Users/hasitha/temp/file-connector-test/dataCollection`. 

!!! Note
    If you set up a FTP server, SFTP server, or a Samba server, do the required configurations and select a working directory. Save the host, port, and security related information for future use. 

## Configure the connector in WSO2 Integration Studio

Follow these steps to set up the Integration Project and the Connector Exporter. 

{!reference/connectors/importing-connector-to-integration-studio.md!} 

## Creating the Integration Logic

1.  Create a new integration project. Be sure to enable a Connector Exporter. 
    
    <img src="{{base_path}}/assets/img/integrate/connectors/filecon1.png" title="create project" width="500" alt="create project"/>


2.  Create an API named `TestAPI` with the `/fileTest` context. This API will accept employee information.

    <img src="{{base_path}}/assets/img/integrate/connectors/filecon2.png" title="create API" width="500" alt="create API"/>

3.  In the default resource of the API, enable POST requests. 

    <img src="{{base_path}}/assets/img/integrate/connectors/filecon3.png" title="select post method" width="500" alt="select post method"/>

4.  Add the Log mediator to the design canvas and configure a custom log that indicates when the API receives a message.  
5.  Add the DataMapper mediator and configure it to transform the incoming XML message to a CSV message. 
6.  Double-click the Datamapper mediator and add a new transform configuration called 'xmlToCsv'.

    <img src="{{base_path}}/assets/img/integrate/connectors/filecon4.png" title="new datamapper config" width="800" alt="new datamapper config"/>

7.  Save the following content as an XML file. This will be the data input file. 

    ```xml
    <test>
    <information>
        <people>
            <person>
                <name>Hasitha</name>
                <age>34</age>
                <company>wso2</company>
            </person>
            <person>
                <name>Johan</name>
                <age>32</age>
                <company>IBM</company>
            </person>
        </people>
    </information>
    </test>
    ```

8.  Load the input file into the Datamapper config view.

    <img src="{{base_path}}/assets/img/integrate/connectors/filecon5.png" title="load input" width="800" alt="load input"/>

9.  Save the following content as a CSV file. This will be the data output file.

    ```
    Name,Age,Company
    Hasitha,34,wso2
    Johan,32,IBM
    ```

10. Load the output CSV file into the datamapper config view.

    <img src="{{base_path}}/assets/img/integrate/connectors/filecon6.png" title="load output csv" width="800" alt="load output csv"/>

11.  Configure the mapping as shown below. Each element in the input should be mapped to the respective element in the output. 

    <img src="{{base_path}}/assets/img/integrate/connectors/filecon7.png" title="data mapping" width="800" alt="data mapping"/>

12.  Specify the input as XML and output as CSV in the datamapper as shown below. 

    <img src="{{base_path}}/assets/img/integrate/connectors/filecon8.png" title="datamapper input output config" width="800" alt="datamapper input output config"/>

13.  Add the Enrich mediator and configure it to save the output generated by the datamapper to a property named `CONTENT`. 

    <img src="{{base_path}}/assets/img/integrate/connectors/filecon9.png" title="enrich - save payload" width="800" alt="enrich - save payload"/>

14. Now, let's use the File connector to check if the file containing employee information already exists in the file system. 

    1.  Add the <b>checkExist</b> operation of the File connector to the canvas.
    2.  Create a new file connection pointing to the working directory we already set up. Keep this as the File connection for the operation.  

        <img src="{{base_path}}/assets/img/integrate/connectors/filecon10.png" title="working directory" width="800" alt="working directory"/>

    3.  Configure the file path as `/dataCollection/employees/employees.csv`. This file will store the employee information. 

        <img src="{{base_path}}/assets/img/integrate/connectors/filecon11.png" title="checkExist operation" width="800" alt="checkExist operation"/>

15. Add the Filter mediator to branch out the logic based on the result from the File connector’s `checkExist` operation. 

    !!! Note
        If the file does not exist, the File connector’s <b>write</b> operation (which we configure later) will create the file.

    1.  Click the Filter mediator and define the filter condition as shown below. 

        <img src="{{base_path}}/assets/img/integrate/connectors/filecon12.png" title="filter mediator" width="800" alt="filter mediator"/>

    2.  Inside the “else” block, add the File Connector's <b>write</b> operation and configure it to write the static content of CSV file headers: “Name,Age,Company”. 

        !!! Note
            Be sure to append a new line at the end of the file. The <b>Write Mode</b> needs to be `Create New`. 

        <img src="{{base_path}}/assets/img/integrate/connectors/filecon13.png" title="create new" width="800" alt="create new"/>

16. After the Filter mediator, use the Enrich mediator again to put back the saved payload into the message payload. 

    <img src="{{base_path}}/assets/img/integrate/connectors/filecon14.png" title="enrich - put back payload" width="800" alt="enrich - put back payload"/>

17.  Add the File connector’s <b>write</b> operation again and configure it to append the CSV message to the existing file. The <b>Write Mode</b> needs to be 'Append'. 

    !!! Note
        As we need the newest message on the top, always append to line number 2. 

    <img src="{{base_path}}/assets/img/integrate/connectors/filecon15.png" title="append to file" width="800" alt="append to file"/>

18. Add the File connector’s <b>read</b> operation and configure it to read the same CSV file. 

    !!! Note
        The file reading will start from line number 2. The content is read as a text message. 

    <img src="{{base_path}}/assets/img/integrate/connectors/filecon16.png" title="read csv file" width="800" alt="read csv file"/>

19. Add the Datamapper mediator again and configure it to convert the CSV message (after reading) back to XML.

    1.  Double-click the data mapper and add a new configuration called 'csvToXml'.

        <img src="{{base_path}}/assets/img/integrate/connectors/filecon17.png" title="output datamapper config" width="800" alt="output datamapper config"/>

    2.  This time, the mapping should be from CSV to XML.

        <img src="{{base_path}}/assets/img/integrate/connectors/filecon18.png" title="output datamapper dialog" width="800" alt="output datamapper dialog"/>

20. Finally, use the <b>Respond</b> mediator to send the transformed message to the API caller. 
21. Now, let's configure a fault sequence to generate an error message when an error occurs in the message flow.

    1.  Creat a fault sequence with a <b>Log</b> mediator and <b>Respond</b> mediator.

        <img src="{{base_path}}/assets/img/integrate/connectors/filecon19.png" title="fault sequence" width="800" alt="fault sequence"/>

    2.  Configure the Log mediator generate a custom error.

        <img src="{{base_path}}/assets/img/integrate/connectors/filecon20.png" title="error log" width="800" alt="error log"/>

    3.  Add the fault sequence to the API resource as its fault sequence. 

{!reference/connectors/exporting-artifacts.md!}

<!--
## Get the project

You can download the ZIP file and extract the contents to get the project code.

<a href="{{base_path}}/assets/attachments/connectors/fileconnector.zip">
    <img src="{{base_path}}/assets/img/integrate/connectors/download-zip.png" width="200" alt="Download ZIP">
</a>
-->

## Deployment

Follow these steps to deploy the exported CApp in the Enterprise Integrator runtime. 

{!reference/connectors/deploy-capp.md!}

## Testing

1. Create a file called data.json with the following payload. 

    !!! Note
        When you configuring this `source` parameter in the Windows operating system, set this property as `<source>C:\\Users\Name\Desktop\Salesforcebulk-connector\create.txt</source>`.

    ```xml
    <test>
    <information>
        <people>
            <person>
                <name>Hasitha</name>
                <age>34</age>
                <company>wso2</company>
            </person>
            <person>
                <name>Johan</name>
                <age>32</age>
                <company>IBM</company>
            </person>
            <person>
                <name>Bob</name>
                <age>30</age>
                <company>Oracle</company>
            </person>
            <person>
                <name>Alice</name>
                <age>28</age>
                <company>Microsoft</company>
            </person>
            <person>
                <name>Anne</name>
                <age>30</age>
                <company>Google</company>
            </person>
        </people>
    </information>
    </test>
    ```
    
2. Invoke the API as shown below using the curl command. 

    !!! Info
        Curl Application can be downloaded from [here](https://curl.haxx.se/download.html).

    ```bash
    curl -H "Content-Type: application/xml" --request POST --data @body.json http://10.100.5.136:8290/fileconnector/create
    ```

3.  Check the file system to verify that the CSV file has been created. 

    <img src="{{base_path}}/assets/img/integrate/connectors/filecon21.png" title="file creation result" width="800" alt="file creation result"/>

4.  If you invoke the API again with a different set of employees, the new employees will get appended to the same file. The response you receive will include all the employees that were added from both messages.

In this example, the File connector was used to create a file, write to a file, and to read a file. By blending these capabilities together with other powerful message manipulation features of WSO2 EI, it is possible to define a working scenario in minutes. The File connector has many more functionalities. Refer the [File Connector reference guide]({{base_path}}/reference/connectors/file-connector/file-connector-config/) for more information. 

## What's Next

* You can deploy and run your project on Docker or Kubernetes. See the instructions in [Running the Micro Integrator on Containers]({{base_path}}/install-and-setup/installation/run_in_containers).
* To customize this example for your own scenario, see [File Connector Configuration]({{base_path}}/reference/connectors/file-connector/file-connector-config/) documentation for all operation details of the connector.
