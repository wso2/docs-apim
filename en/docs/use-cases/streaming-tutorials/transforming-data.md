# Transforming Streaming Data

## Introduction

In this tutorial, you can try out a few scenarios that involve transforming data from one format to another to understand how the Streaming Integrator component can perform transforming activities on streaming data.

## Transforming data from one format to another

To understand how the Streaming Integrator can transform streaming data from one format to another, consider an example where a bot in an airport generates and stores departure flight details in the CSV format, but these records need to be converted to JSON format for further processing. To do this via the Streaming Integrator, follow the steps below:

1. Download `flights.csv` file from [here](https://github.com/wso2/docs-ei/tree/master/en/streaming-integrator/docs/examples/resources/flights.csv) and save it in a location of your choice.

2. Start the Streaming Integrator Tooling by navigating to the `<SI_TOOLING_HOME>/bin` directory and issuing one of the following commands as appropriate, based on your operating system:
   
    - For Windows: `tooling.bat`
    
    - For Linux: `./tooling.sh`

3. Open a new file and create a Siddhi application named `ConvertStreamingEventsApp`. You can specify the Siddhi application name via the `@App:name` annotation as shown below.

    ```
    @App:name("ConvertStreamingEventsApp")
    ```
   
4. Create a stream that consumes events from the `flights.csv` file in the CSV format as follows:

    ```
    @source(type='file', mode='LINE',
        file.uri='file:/Users/foo/flights.csv',
        tailing='true',
        @map(type='csv'))
    define stream FlightsStream(flight string, passengers int);
    ```
    !!! info
        Replace `Users/foo` with the actual path to the location in which you saved the `flights.csv` file.
   
   The above stream definition receives events with values for the `flight` and `passengers` fields. The source annotation connected to it specifies that these events are counsumed from a file named `flights.csv` in the `/Users/foo/` directory in the `CSV` format. This file is tailed for new events. 
   
5. To generate the output in `JSON`, define an output stream as follows.

    ```
    @sink(type = 'file', file.uri = "file:/Users/foo/convertedflightdetails.json",
    	@map(type = 'json'))
    define stream OutputStream(flight string, passengers int);
    ```
   
   !!! info
       You can replace `Users/foo` with a path to a preferred location in your machine.
   
   The above stream generates output events with values for the `flight` and `passengers` attributes. The connected sink annotation of the `file` type specifies that output events generated in the stream are published to the `Users/foo/output.json` file in JSON format.
   
6. To direct the events from the `FlightsStream` stream to the `OutputStream` stream, write a query as follows.

    ```
    @info(name = 'Generate JSON Events')
    from FlightsStream 
    select * 
    insert into OutputStream;
    ```
   
   The above query selects all the events in the `FlightsStream` stream and inserts them into the `OutputStream` stream.
   
7. Save the Siddhi application. The complete Siddhi application is as follows:

    ```
    @App:name('ConvertStreamingEventsApp')
    @App:description('Description of the plan')
    
    @source(type='file', mode='LINE',
        file.uri='file:/Users/foo/flights.csv',
        tailing='true',
        @map(type='csv'))
    define stream FlightsStream(flight string, passengers int);
    
    @sink(type = 'file', file.uri = "file:/Users/foo/convertedflightdetails.json",
    	@map(type = 'json'))
    define stream OutputStream(flight string, passengers int);
    
    @info(name = 'Generate JSON Events')
    from FlightsStream 
    select * 
    insert into OutputStream;
    ```
   
8. Start the Siddhi application by clicking on the **Play** icon.

    ![Play]({{base_path}}/assets/img/streaming/extracting-data-from-static-sources/play.png)
    
9. Open the `Users/foo/flights.csv` file and add a new row as follows.

    ```
    TK-1435,230
    ```
      
    Save the change you made.
    
10. Open the `Users/foo/output.json`. It contains the output events in JSON format as shown in the following extract.

    ![Converted JSON Events]({{base_path}}/assets/img/streaming/transforming-data-tutorial/json-events-extract.png)

## Transforming JSON

In this section, let's manipulate streaming data in JSON format.

### Converting one JSON format to another JSON format

To convert an event in one JSON format to another JSON format, consider an example of an airport where passenger flight details during the day are generated by a bot in a specific JSON format. However, a record keeper needs to store them in a different JSON format.

The flight details are received as follows:

```
{
  "flightNo": "QR-1405",
  "type": "passenger"
  "Details": {
    "aircraft": "A320",
    "seats": 240
    "passengers": 221
  }
}
```

Assume that the record keeper only wants to record the flight number and the number of passengers, and that he/she needs to record them in the following format. 

```

{
  "event": {
    "flight": "QR-1405",
    "passengers": 221
  }
}
```

To do this, follow the steps below:

1. In Streaming Integrator Tooling, open a new file and start creating a new Siddhi application named `ConvertFormatApp`.

    ```
    @App:name("ConvertFormatApp")
    ```
   
2. Define an input stream named `ReceiveFlightDetailsStream` to receive JSON events in the expected format (i.e., as per the given example).

    ```
    @source(type='http', receiver.url='http://localhost:5005/FlightsEP', @map(type = 'json', @attributes(flight = '$.flightNo', passengers = '$.Details.passengers')))
    define stream ReceiveFlightDetailsStream (flight string, passengers int);
    ```
   
   The `ReceiveFlightDetailsStream` selects events that present the flight number as `flight`, and the number of passengers as `passengers`. These events are received as HTTP events. The source annotation (i.e., `@source`) connected to the stream listens to the events at the `http://localhost:5005/FlightsEP` port. The map annotation (i.e., `@map`) extracts the required information from the HTTP event via `JSONPath` expressions. `flight = '$.flightNo'` specifies that the value of the `flightNo` attribute in the HTTP event is the value for `flight`. Similarly, `passengers = '$.Details.passengers'` that the `passengers` attribute nested under `Details` in the HTTP event is the value for `passengers`.
   
3. To save the converted events in a file, define an output stream with a sink of the `file` type connected to it as shown below.

    ```
    @sink(type='file' , file.uri='file:/Users/foo/flightdetails.json', @map(type = 'json')) 
    define stream RecordFlightDetailsStream (flight string, passengers int);
    ```
   
    The `RecordFlightDetailsStream` output stream has the same attributes as the `ReceiveFlightDetailsStream` input stream. The file sink connected to it indicates that each output event generated in the stream is saved in the `Users/foo/flightdetails.json` file in JSON format.
    
    !!! info
        You can replace `Users/foo` with a path to a preferred location in your machine.
    
4. To direct the events from the `ReceiveFlightDetailsStream` stream to the `RecordFlightDetailsStream` stream, write a query as follows.
   
   ```
   @info(name = 'Save Converted Events')
   from ReceiveFlightDetailsStream 
   select * 
   insert into RecordFlightDetailsStream;
   ```
  
  The above query selects all the events in the `ReceiveFlightDetailsStream ` stream and inserts them into the `RecordFlightDetailsStream` stream.
  
5. Save the Siddhi application. The complete Siddhi application is as follows:

    ```
    @App:name("ConvertFormatApp")
    
    @source(type='http', receiver.url='http://localhost:5005/FlightsEP', @map(type = 'json', @attributes(flight = '$.flightNo', passengers = '$.Details.passengers')))
    define stream ReceiveFlightDetailsStream (flight string, passengers int);
    
    @sink(type='file' , file.uri='file:/Users/foo/flightdetails.json', @map(type = 'json')) 
    define stream RecordFlightDetailsStream (flight string, passengers int);
    
    @info(name = 'Save Converted Events')
    from ReceiveFlightDetailsStream 
    select * 
    insert into RecordFlightDetailsStream;
    ```
   
6. Start the Siddhi application by clicking on the **Play** icon.
   
    ![Play]({{base_path}}/assets/img/streaming/extracting-data-from-static-sources/play.png)
    
7. Issue the following CURL commands.

    ```   
    curl -X POST \
      http://localhost:5005/FlightsEP \
      -H 'content-type: application/json' \
      -d '{
      "flightNo": "QR-1405",
      "type": "passenger",
      "Details": {
        "aircraft": "A320",
        "seats": 240,
        "passengers": 221
      }
    }'
    ```
  
    ```   
    curl -X POST \
      http://localhost:5005/FlightsEP \
      -H 'content-type: application/json' \
      -d '{
      "flightNo": "TK-2320",
      "type": "passenger",
      "Details": {
        "aircraft": "A321",
        "seats": 240,
        "passengers": 210
      }
    }'
    ```
8. Open the `Users/foo/flightdetails.json` file. The events you generated by issuing CURL commands are saved in JSON format as follows:

    ![Output JSON Events in Converted Format]({{base_path}}/assets/img/streaming/transforming-data-tutorial/converted-json-events-extract.png)
   

### Manipulating a JSON object using execution JSON

This section explains how to manipulate a JSON object via the `siddhi-execution-json` Siddhi extension. To try this out, consider a scenario where the flight operators in the departure terminals of WUA airport need to keep the flight display systems updated with the latest information relating to flights. The flight operator needs to add each flight to the display two hours before departure. The information in the display item needs to be updated when a gate is assigned, and when there is a change in the gate status. To allow the flight operators do this via the system, let's write a Siddhi application as follows:

1. In Streaming Integrator Tooling, open a new file and start creating a new application named `FlightInformationDisplayApp`.

    ```
    @App:name("FlightInformationDisplayApp")
    ```
   
2. To get the flight details in JSON format, define an input stream as follows.

    ```
    define stream FlightInfoStream (flight string, destination string, time string, gate string, status string);
    ```
   
3. To present the information to be displayed in the flight information display, define an output stream as follows.

    ```
    define stream OutputStream  (flight string, destination string, time string, gate string);
    ```
   
4. To get extract events from the JSON payload, write a query as follows:

``` 
curl -X POST \
  http://localhost:5005/FlightsInfoEP \
  -H 'content-type: application/json' \
  -d '{
  "flightNo": "TK-2320",
  "passenger": true,
  "direction": "arrival",
  "Details": {
    "aircraft": "A321",
    "seats": 240,
    "passengers": 210
  }
}'
```

### Splitting a JSON array to multiple events

In this section, let's learn how to split a JSON array into multiple JSON objects via the [siddhi-execution-json Siddhi extension](https://siddhi-io.github.io/siddhi-execution-json/api/latest/).

Consider an example at WUA airport where once a gate controller at a terminal opens the gate for a few flights, he/she sends the list of flights in batch as a JSON array. However, when sending the same information to flight information display systems for passengers, the status of each flight must be extracted from the JSON array and sent as a separate JSON object. 

To understand how this can be done via the Streaming Integrator, follow the steps below:

1. In Streaming Integrator Tooling, open a new file and start creating a new Siddhi application named `GateStatusUpdateApp`.

    ```
    @App:name("GateStatusUpdateApp")
    ```
   
2. Define an input stream to receive the update about the gate status as a JSON array.

    ```
    @source(type = 'http', receiver.url = "http://localhost:5005/GateInfoEP",
        @map(type = 'json',
            @attributes(flight = "$.flight", status = "$.gateStatus")))
    define stream InputStream (status string, flight string);
    ```
   
   The source of the `http` type connected to the stream that the event is received in JSOn format to the `http://localhost:5005/GateInfoEP` HTTP endpoint. The `@attributes` annotation specifies the JSON expressions via which the values for the attributes are derived from the JSON event.
   
3. To generate the response (i.e., The JSON objects derived by splitting the array), define an output stream as follows:

    ```
    @sink(type = 'file', file.uri = "file:/Users/rukshani/documents/csvfiles/gatedetails.json",
        @map(type = 'json'))
    define stream OutputStream (status string, flight string);
    ```
   
    The connected sink of the `file` type indicates that the JSON objects derived by splitting the array are saved in the `Users/foo/gatedetails.json`.

4. To generate JSON objects as events in the output stream, write a Siddhi query as follows:

    ```text
    @info(name = 'query1')
    from InputStream#json:tokenize(flight, '$')  
    select json:getString(status, '$.gateStatus') as status, flight 
    insert into OutputStream;
    ```   
   
   This query gets the input event (i.e., the JSON array) from `InputStream` stream and inserts the output events (i.e., the JSON objects) into the `OutputStream` stream. The `json:tokenize()` function is applied to the input stream, and it specifies that the `flight, '$` path in the JSON event needs to be tokenized (split). 
   
5. Save the Siddhi application. The complete Siddhi application looks as follows:

    ```
    @App:name('GateStatusUpdateApp')
    @App:description('Description of the plan')
    
    @source(type = 'http', receiver.url = "http://localhost:5005/GateInfoEP",
        @map(type = 'json',
            @attributes(flight = "$.flight", status = "$.gateStatus")))
    define stream InputStream (status string, flight string);
    
    @sink(type = 'file', file.uri = "file:/Users/rukshani/documents/csvfiles/gatedetails.json",
        @map(type = 'json'))
    @sink(type = 'log', prefix = "split events",
        @map(type = 'json'))
    define stream OutputStream (status string, flight string);
    
    @info(name = 'query1')
    from InputStream#json:tokenize(flight, '$')  
    select json:getString(status, '$.gateStatus') as status, flight 
    insert into OutputStream;
    ```

6. Start the Siddhi application by clicking on the **Play** icon.
      
    ![Play]({{base_path}}/assets/img/streaming/extracting-data-from-static-sources/play.png)
    
7. Issue the following CURL command

    ``` 
    curl -X POST  http://localhost:5005/GateInfoEP -H 'content-type: application/json' -d '{"gateStatus":"open", "flight": [{"flight":"TK-2320"},{"flight":"TK-2310"},{"flight":"QR-1405"}]}'
    ```
8. Open the `Users/rukshani/documents/csvfiles/gatedetails.json` file. The contents are as follows:

    ```
    
    ```


## Transforming XML

This section shows you how the Streaming Integrator component transforms data received in XML format.


### Converting one XML format to another XML format

For this scenario, consider the example where flight details are received in the following XML format:

```    
<flightevent>
    <flight>QR-1405</flight>
    <details>
       <destination>lisbon</destination>
       <passengers>200</passengers>
       <duration>3h 30 min</duration>
    </details>
</flightevent>
```
 
However, the record keeper needs to save them in a file in the following format:

```
<flight>QR-1405</flight>
<destination>lisbon</destination>
<passengers>200</passengers>
<timeDuration>3.5</duration>
```

To perform this transformation, follow the steps below:

1. Open a new file in your favourite text editor. Copy the following content to it and save it in a preferred location.

    ```
    <?xml version="1.0" encoding="UTF-8"?>
    <flights>
       <flightevent>
          <flight>QR-1405</flight>
          <details>
             <destination>lisbon</destination>
             <passengers>200</passengers>
             <duration>6 35m</duration>
          </details>
       </flightevent>
       <flightevent>
          <flight>QR-0273</flight>
          <details>
             <destination>amsterdam</destination>
             <passengers>220</passengers>
             <duration>7h 40m</duration>
          </details>
       </flightevent>
       <flightevent>
          <flight>QR-1019</flight>
          <details>
             <destination>amsterdamn</destination>
             <passengers>210</passengers>
             <duration>7h 35m</duration>
          </details>
       </flightevent>
    </flights>
    ```
   For this example, let's assume that it is saved in the `/users/foo` directory.
   
2. In streaming Integrator Tooling, open a new file and start creating a new Siddhi application named `ConvertXMLFormatApp`.

    ```
    @App:name("ConvertXMLFormatApp")
    ```
   
3. To receive the XML events, define an input stream as follows.

    ```
    @source(type = 'file', file.uri = "file:/users/rukshani/documents/xmlfiles/flights.xml",
        @map(type = 'xml', enclosing.element = "flights",
            @attributes(flight = "flight", destination = "details/destination", passengers = "details/passengers", timeDuration = "details/duration")))
    define stream FlightInfoStream (flight string, destination string, passengers int, timeDuration string);
    ```
   
   The stream definition has all the attributes of the expected format in the required format (i.e., `flight`, `destination`, `passengers` and `timeDuration`). The connected source specifies that the events are received from the `users/documents/xmlfiles/flights.xml` file that you previously saved. According to the `@map` annotation, these events are received in XML format. The `@attributes` annotation specifies how the value for each attribute in the stream, is derived from the stream. The value for the `flight` attribute is derived from the attribute of the same name in the incoming event. The values for the other attributes are nested below the `details` attribute in the incoming event, and to indicate this, `@attribute` annotation specifies the XPath expression (e.g., `passengers = "details/passengers"`). When the name of the corresponding attribute in the incoming event is different, the XPath expression specifies it (e.g., `timeDuration = "details/duration"`).
   
4. To generate the output events, define an output stream as follows:

    ```
    @sink(type = 'file', file.uri = "file:/users/foo/formatttedflights.xml",
    @map(type = 'xml'))
    define stream FormattedFlightInfoStream (flight string, destination string, passengers int, timeDuration string);
    ```
   The above stream definition has the same attributes as the `FlightInfoStream` input stream. The connected sink of the `file` type publishes the output events generated in the stream to the `users/foo/formatttedflights.xml` file in XML format.
   
5. To select all the events from the `FlightInfoStream` input stream and insert them into the `FormattedFlightInfoStream`, add a query as follows.

    ```
    @info(name = 'Publish formatted events')
    from FlightInfoStream 
    select * 
    insert into FormattedFlightInfoStream;
    ```
   
6. Save the Siddhi application. The complete Siddhi application is as follows:

    ```
    @App:name('ConvertXMLFormatApp')
    @App:description('Description of the plan')
    
    @source(type = 'file', file.uri = "file:/users/foo/flights.xml",
    	@map(type = 'xml',
    		@attributes(flight = "flight", passengers = "details/passengers", destination = "details/destination", timeDuration = "details/duration")))
    define stream FlightInfoStream (flight string, destination string, passengers int, timeDuration string);
    
    @sink(type = 'file', file.uri = "file:/users/foo/formatttedflights.xml",
    	@map(type = 'xml'))
    define stream FormattedFlightInfoStream (flight string, destination string, passengers int, timeDuration string);
    
    @info(name = 'Publish formatted events')
    from FlightInfoStream 
    select * 
    insert into FormattedFlightInfoStream;
    ```
   
7. Start the Siddhi application by clicking on the **Play** icon.
   
   ![Play]({{base_path}}/assets/img/streaming/extracting-data-from-static-sources/play.png)
   

   
### Performing XSLT like transformation

### Splitting an XML array to multiple events

## Manipulating strings