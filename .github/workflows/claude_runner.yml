name: Claude Code • Auto PR on Comment

on:
  issue_comment:
    types: [created]

jobs:
  run-claude:
    if: contains(github.event.comment.body, '@claude')
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: write
      pull-requests: write

    steps:
      # Checkout repo
      - name: Checkout repository
        uses: actions/checkout@v4

      # Extract version from issue body (if any)
      - name: Detect version from issue
        id: version
        env:
         GITHUB_TOKEN: ${{ secrets._GITHUB_TOKEN }}
        run: |
          ISSUE_BODY="${{ github.event.issue.body }}"
          VERSION=$(echo "$ISSUE_BODY" | grep -oE "([0-9]+\.[0-9]+\.[0-9]+)" | head -1 || true)

          if [ -z "$VERSION" ]; then
            echo "⚠️ No version found in issue, using latest branch"
            VERSION=$(git branch -r | grep "release/" | sed 's|.*/||' | sort -V | tail -1)
          fi

          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "Using version: $VERSION"

      # Checkout the version branch
      - name: Switch to version branch
        env:
         GITHUB_TOKEN: ${{ secrets._GITHUB_TOKEN }}
        run: |
          git fetch --all
          if git show-ref --verify --quiet refs/remotes/origin/release/${VERSION}; then
            git checkout -b fix/${{ github.event.issue.number }} origin/release/${VERSION}
          else
            echo "❌ Branch release/${VERSION} not found"
            exit 1
          fi

      # Setup Claude CLI
      - name: Setup Claude Code
        uses: anthropics/claude-code-action@v1

      # Load system prompt into env var
      - name: Load system prompt
        id: load_prompt
        run: |
          echo "SYSTEM_PROMPT<<EOF" >> $GITHUB_ENV
          cat .claude/system_prompt.txt >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      # Run Claude to solve issue and create PR
      - name: Run Claude and create PR
        env:
          GITHUB_TOKEN: ${{ secrets._GITHUB_TOKEN }}
        run: |
          claude \
            --system_prompt "$SYSTEM_PROMPT" \
            --max_runtime_minutes 60 \
            --allow_commit true \
            --create_pr true \
            --model claude-3-5-sonnet-20240620 \
            --pr_title "Fix(issue #${{ github.event.issue.number }}): ${GITHUB_ENV.VERSION}" \
            --pr_body "This PR was automatically generated by Claude for issue #${{ github.event.issue.number }} on version ${VERSION}."
