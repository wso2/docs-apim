name: Claude Runner

on:
  issue_comment:
    types: [created]

jobs:
  run-claude:
    if: contains(github.event.comment.body, '@claude')
    runs-on: ubuntu-latest
    env:
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      GITHUB_TOKEN: ${{ secrets._GITHUB_TOKEN }}
      ORIGINAL_REPO: ${{ secrets.ORIGINAL_REPO }}
      REPO_OWNER: ${{ secrets.REPO_OWNER }}
      REPO_NAME: ${{ secrets.REPO_NAME }}
      LATEST_VERSION: ${{ secrets.LATEST_VERSION }}
    permissions:
        issues: write
        contents: write
        pull-requests: write
        id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        
      - name: Verify system prompt file exists
        run: |
          echo "Workspace path: ${{ github.workspace }}"
          if [ -d "${{ github.workspace }}/.claude" ]; then
            echo ".claude directory exists"
            ls -la "${{ github.workspace }}/.claude"
          else
            echo "ERROR: .claude directory does not exist!"
            exit 1
          fi
          
          if [ -f "${{ github.workspace }}/.claude/system_prompt.txt" ]; then
            echo "system_prompt.txt exists"
            echo "First 10 lines of system_prompt.txt:"
            head -n 10 "${{ github.workspace }}/.claude/system_prompt.txt"
          else
            echo "ERROR: system_prompt.txt does not exist!"
            exit 1
          fi

      - name: Run Claude Code on PR
        id: run-claude
        uses: anthropics/claude-code-action@v1
        with:
            prompt: "You are the intelligent AI Agent. You have to first identify the issue and accordingly you need to fix the issue and create the PR for the relevant branch. Follow the instructions in the system prompt file carefully."
            anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
            claude_args: |
                --system-prompt "${{ github.workspace }}/.claude/system_prompt.txt"
                --max-turns 10
                --model claude-sonnet-4-20250514


      - name: Remove 'claude:in-progress' label
        if: success() && steps.run-claude.outcome == 'success'
        uses: actions-ecosystem/action-remove-labels@v1
        with:
          github_token: ${{ secrets._GITHUB_TOKEN }}
          labels: claude:in-progress

      - name: Add 'claude:pr-created' label
        if: success() && steps.run-claude.outcome == 'success'
        uses: actions-ecosystem/action-add-labels@v1
        with:
          github_token: ${{ secrets._GITHUB_TOKEN }}
          labels: claude:pr-created
