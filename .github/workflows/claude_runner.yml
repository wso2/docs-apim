name: Claude Runner

on:
  issue_comment:
    types: [created]

jobs:
  run-claude:
    if: contains(github.event.comment.body, '@claude')
    runs-on: ubuntu-latest
    env:
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      GITHUB_TOKEN: ${{ secrets._GITHUB_TOKEN }}
      ORIGINAL_REPO: ${{ secrets.ORIGINAL_REPO }}
      REPO_OWNER: ${{ secrets.REPO_OWNER }}
      REPO_NAME: ${{ secrets.REPO_NAME }}
      LATEST_VERSION: ${{ secrets.LATEST_VERSION }}

    permissions:
        issues: write
        contents: write
        pull-requests: write
        id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Extract issue information
        id: issue_info
        run: |
          # Extract issue number from the context
          ISSUE_NUMBER=$(echo "${{ github.event.issue.number }}")
          ISSUE_TITLE=$(echo "${{ github.event.issue.title }}")
          ISSUE_BODY=$(echo "${{ github.event.issue.body }}")
          REPO_FULLNAME="${{ github.repository }}"
          
          echo "ISSUE_NUMBER=$ISSUE_NUMBER" >> $GITHUB_ENV
          echo "ISSUE_TITLE=$ISSUE_TITLE" >> $GITHUB_ENV
          echo "REPO_FULLNAME=$REPO_FULLNAME" >> $GITHUB_ENV
          
          # For debugging
          echo "Working on issue #$ISSUE_NUMBER in repository $REPO_FULLNAME"
          echo "Issue title: $ISSUE_TITLE"
        
      - name: Verify system prompt file exists
        run: |
          echo "Workspace path: ${{ github.workspace }}"
          if [ -d "${{ github.workspace }}/.claude" ]; then
            echo ".claude directory exists"
            ls -la "${{ github.workspace }}/.claude"
          else
            echo "ERROR: .claude directory does not exist!"
            exit 1
          fi
          
          if [ -f "${{ github.workspace }}/.claude/system_prompt.txt" ]; then
            echo "system_prompt.txt exists"
            echo "First 10 lines of system_prompt.txt:"
            head -n 10 "${{ github.workspace }}/.claude/system_prompt.txt"
          else
            echo "ERROR: system_prompt.txt does not exist!"
            exit 1
          fi
      
      - name: Setup GitHub CLI for Claude
        run: |
          # Configure GitHub CLI to use the token without explicit login
          # GitHub CLI automatically uses GITHUB_TOKEN in GitHub Actions
          
          # Enable command approval for Claude
          mkdir -p ~/.config/gh/
          echo "command_approval: false" > ~/.config/gh/config.yml
          
          # Verify auth status (should already be authenticated)
          gh auth status || echo "GitHub CLI authentication check failed but continuing..."
          
          # Ensure the token is passed to Claude's environment
          echo "GH_TOKEN=${{ secrets._GITHUB_TOKEN }}" >> $GITHUB_ENV


      - name: Run Claude Code on PR
        id: run-claude
        uses: anthropics/claude-code-action@v1
        env:
          GH_TOKEN: ${{ secrets._GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          REPO_FULLNAME: ${{ github.repository }}
        with:
            prompt: >-
              You are the intelligent AI Agent working on issue #${{ github.event.issue.number }} in the repository ${{ github.repository }}.
              The issue title is: "${{ github.event.issue.title }}"

              You need to fix the issue and create the PR for the relevant branch. Follow the instructions in the system prompt file carefully.
              After solving the issue, make sure to create the PR for the relevant branch.
              After creating the PR, make sure to remove the label 'claude:in-progress' and add the label 'claude:pr-created' label to the issue.
              
              If this issue appears in other versions of the repository, then you need to solve it in those versions as well and create PRs for each version.
              
              To view the issue details, you can run:
              gh issue view ${{ github.event.issue.number }} --repo ${{ github.repository }}
            anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
            claude_args: |
                --system-prompt "${{ github.workspace }}/.claude/system_prompt.txt"
                --max-turns 10
                --model claude-sonnet-4-20250514
                --allowedTools shell web-search
                

      - name: Remove 'claude:in-progress' label
        if: success() && steps.run-claude.outcome == 'success'
        uses: actions-ecosystem/action-remove-labels@v1
        with:
          github_token: ${{ secrets._GITHUB_TOKEN }}
          labels: claude:in-progress

      - name: Add 'claude:pr-created' label
        if: success() && steps.run-claude.outcome == 'success'
        uses: actions-ecosystem/action-add-labels@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          labels: claude:pr-created
