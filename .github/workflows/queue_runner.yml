name: Claude Queue Runner
on:
  schedule:
    - cron: "0 * * * *" 
  workflow_dispatch: {}

concurrency:
  group: claude-queue-runner
  cancel-in-progress: false

jobs:
  queue-runner:
    runs-on: ubuntu-latest
    name: Process next issue in Claude queue
    steps:
      - uses: actions/checkout@v4

      - name: Install GitHub CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y gh jq 

      - name: Pick next queued issue
        id: pick
        env: 
          GITHUB_TOKEN: ${{ secrets.DOC_FIXING_AGENT_GITHUB_TOKEN }}

        run: |
          # Check if any issue is already in progress
          IN_PROGRESS=$(gh issue list --label "AI-Agent/In-Progress" --state open --json number | jq 'length')
          if [ "$IN_PROGRESS" -gt 0 ]; then
            echo "issue_in_progress=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Get oldest open issue with AI-Agent/Queued label
          ISSUE_JSON=$(gh issue list --label "AI-Agent/Queued" --state open --json number,createdAt --limit 100 \
            | jq '[.[]] | sort_by(.createdAt) | .[0]')

          if [ "$ISSUE_JSON" = "null" ] || [ -z "$ISSUE_JSON" ]; then
            echo "issue_number=" >> $GITHUB_OUTPUT
            exit 0
          fi

          ISSUE_NUMBER=$(echo "$ISSUE_JSON" | jq -r .number)
          echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT

      - name: Exit if no queued issues
        if: steps.pick.outputs.issue_number == ''
        run: echo "No queued issues."

      - name: Update labels and trigger Claude
        env: 
          GITHUB_TOKEN: ${{ secrets.DOC_FIXING_AGENT_GITHUB_TOKEN }}
        if: steps.pick.outputs.issue_number != ''
        run: | 
          ISSUE=${{ steps.pick.outputs.issue_number }}

          # Remove AI-Agent/Queued, add AI-Agent/In-Progress
          gh issue edit $ISSUE --remove-label "AI-Agent/Queued"
          gh issue edit $ISSUE --add-label "AI-Agent/In-Progress"

          # Add trigger comment for Claude
          gh issue comment $ISSUE --body "@wso2-engineering-bot create a PR for this issue following repo conventions"
