name: Claude Code â€¢ auto-label issues

on:
  issues:
    types: [opened, edited]

jobs:
  auto-label:
    runs-on: ubuntu-latest
    name: Auto-label issues for Claude processing
    permissions:
      issues: write
    steps:
      # Checkout repo (required if you later read files)
      - name: Checkout repository
        uses: actions/checkout@v4

      # Install GitHub CLI and Claude CLI
      - name: Install GitHub & Claude CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y gh
          npm install -g @anthropic-ai/claude-code
    
      - name: Classify issue via Claude API
        env:
            ANTHROPIC_API_KEY: ${{ secrets.ANTHOPIC_API_KEY }}
            GITHUB_TOKEN: ${{ secrets._GITHUB_TOKEN }}
            ISSUE_NUMBER: ${{ github.event.issue.number }}
            
            ISSUE_TITLE: ${{ github.event.issue.title }}
            ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
           echo "Sending issue to Claude for classification..."

            # Build JSON payload safely with jq to escape newlines/quotes
            PROMPT="You are a GitHub issue classifier. Read the issue title and body carefully. Classify the issue into one of these categories: broken_links, spelling_mistakes, grammatical_errors, formatting_issues, suggestions, none. Return ONLY the category name. And if the issue does not fit any category, return 'none'.
            Example for the broken links:
                Location : https://apim.docs.wso2.com/en/latest/manage-apis/deploy-and-publish/deploy-on-gateway/federated-gateways/deploy-on-aws-api-gateway/
                 link on sub step 2 in Step 3 : Configure a third party Key Manager is returning page not found error
            Example for the spelling mistakes:
                Title: Speling mistake in the doc
                Body: There is a speling mistake in the second paragraph of the doc.
            Example for the grammatical errors:
                Title: Grammatical error in the doc
                Body: The sentence "This are the steps to configure the API" should be "These are the steps to configure the API".
            Example for the formatting issues:
                Title: Formatting issue in the doc
                Body: The code block in the "Setup" section is not properly formatted.
            Example for the suggestions:
                Title: Suggestion for improving the doc
                Body: It would be helpful to add a troubleshooting section for common errors.
    

            Title: $ISSUE_TITLE
            Body: $ISSUE_BODY"

                DATA=$(jq -n --arg prompt "$PROMPT" '{
                model: "claude-3-5-sonnet-20240620",
                max_tokens: 50,
                messages: [{role: "user", content: $prompt}]
                }')

                # Call Claude API with required anthropic-version header
                RESPONSE=$(curl -s https://api.anthropic.com/v1/messages \
                -H "Content-Type: application/json" \
                -H "x-api-key: $ANTHROPIC_API_KEY" \
                -H "anthropic-version: 2023-06-01" \
                -d "$DATA")

                echo "Claude response: $RESPONSE"

                CATEGORY=$(echo "$RESPONSE" | jq -r '.content[0].text' | tr -d '\n' | tr '[:upper:]' '[:lower:]')
                echo "Claude classified the issue as: $CATEGORY"

                # Add claude:queue label if a valid category is returned
                if [[ "$CATEGORY" != "" && "$CATEGORY" != "null" && "$CATEGORY" != "none" ]]; then
                echo "Adding claude:queue label"
                gh issue edit $ISSUE_NUMBER --add-label "claude:queue"
                else
                echo "No valid category returned. Not adding label."
                fi